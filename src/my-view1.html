<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view1">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      #codeInput {
        --paper-input-container-input: {
          text-transform: uppercase;
        }
      }
    </style>

    <firebase-query id="query" path="/party_keys"></firebase-query>
    
    <iron-meta key="partyCodeFormat" value="{{_partyCodeFormat}}"></iron-meta>
    
    <app-localstorage-document
        id="idStorage"
        key="party:id"
        data="{{_storedId}}"></app-localstorage-document>

    <paper-input
        id="codeInput"
        maxlength="[[_partyCodeFormat.length]]"
        pattern="[[_partyCodeFormat.allowedInput]]"
        error-message="[[_errorMessage]]"
        on-value-changed="_codeInputChanged"></paper-input>

    <h1>pid: [[_storedId]]</h1>

  </template>

  <script>
    class MyView1 extends Polymer.Element {

      static get is() { return 'my-view1'; }

      static get properties() {
        return {
          _partyCodeFormat: Object,

          _errorMessage: String,
          _storedId: String,
        };
      }

      _codeInputChanged(_, e) {
        const codeInput = this.$.codeInput;
        codeInput.validate();
        if (codeInput.invalid) {
          this._errorMessage = 'Invalid party code format.' +
                               ' Party codes are 4 letters ex. \"ABCD\"';
          return;
        }
        if (e.value.length !== codeInput.maxlength) {
          return;
        }
        this._joinPartyWithCode(e.value.toUpperCase())
          .then((partyId) => {
            this._storeId(partyId);
          })
          .catch((err) => {
            this._errorMessage = err;
            codeInput.invalid = true;
          });
      }

      _joinPartyWithCode(code) {
        if (!this._partyCodeFormat.exactFormat.test(code)) return;

        return new Promise((resolve, reject) => {
          this.$.query.ref.child(code).once('value', (snapshot) => {
            const partyId = snapshot.val();
            partyId ? resolve(partyId) : reject('Party not found');
          })
          .catch((err) => {
            console.error(err);
            reject('Some database error occured :(');
          });
        });
      }

      _storeId(id) {
        this._storedId = id;
        this.$.idStorage.transactionsComplete.then(() => {
          this.dispatchEvent(new CustomEvent('set-route',
                                             {detail: {path: 'queue'},
                                              composed: true}));
        })
        .catch((err) => {
          console.error(err);
        });
      }

    }

    window.customElements.define(MyView1.is, MyView1);
  </script>
</dom-module>
