<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view1">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      #codeInput {
        --paper-input-container-input: {
          text-transform: uppercase;
        }
      }
    </style>

    <firebase-auth id="auth" user="{{user}}"></firebase-auth>
    
    <iron-meta key="partyCodeFormat" value="{{_partyCodeFormat}}"></iron-meta>

    <paper-input
        id="codeInput"
        maxlength="[[_partyCodeFormat.length]]"
        pattern="[[_partyCodeFormat.allowedInput]]"
        error-message="[[_errorMessage]]"
        on-value-changed="_codeInputChanged"></paper-input>

    <h1>pid: [[partyId]]</h1>

  </template>

  <script>
    class MyView1 extends Polymer.Element {

      static get is() { return 'my-view1'; }

      static get properties() {
        return {
          partyId: String,
          _partyCodeFormat: Object,
          _errorMessage: String,
        };
      }

      _codeInputChanged(_, e) {
        const codeInput = this.$.codeInput;
        const code = e.value;
        codeInput.validate();
        if (codeInput.invalid) {
          this._errorMessage = 'Invalid party code format.' +
                               ' Party codes are 4 letters ex. \"ABCD\"';
          return;
        }
        if (code.length !== codeInput.maxlength) {
          return;
        }

        this._getPartyIdFromCode(code.toUpperCase()).then((partyId) => {
          if (!this.user) {
            return this.$.auth.signInAnonymously().then((user) => {
              return firebase.database().ref(`users/${user.uid}`).set({
                isAnonymous: true
              });
            }).then(() => {
              return partyId;
            });
          } else {
            return partyId;
          }
        }).then((partyId) => {
          return this._joinPartyWithId(partyId, this.user);
        }).then(() => {
          this.dispatchEvent(new CustomEvent('set-route',
                                             {detail: {path: 'queue'},
                                              composed: true}));
        }).catch((err) => {
          console.log(err.message);
          this._errorMessage = err.message === 'Party not found' ? 
                               err.message : 
                               'Error joining party ):';
          codeInput.invalid = true;
        });
      }

      _getPartyIdFromCode(code) {
        return new Promise((resolve, reject) => {
          firebase.database().ref('party_keys').child(code).once('value', (snapshot) => {
            const partyId = snapshot.val();
            partyId ? resolve(partyId) : reject(new Error('Party not found'));
          }).catch((err) => {
            reject(new Error(`Error getting party id: ${err.message}`));
          });
        });
      }

      _joinPartyWithId(partyId, user) {
        return firebase.database().ref(`users/${user.uid}`).update({
          party: partyId,
          host: false
        }).then(() => {
          return firebase.database().ref(`members/${partyId}/${user.uid}`).set({
            isAnonymous: user.isAnonymous
          });
        });
      }

    }

    window.customElements.define(MyView1.is, MyView1);
  </script>
</dom-module>
