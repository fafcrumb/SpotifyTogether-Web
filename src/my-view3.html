<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="lazy-import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="lazy-import" href="../bower_components/polymerfire/firebase-auth.html">

<link rel="import" href="shared-styles.html">

<dom-module id="my-view3">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      #searchResults {
        opacity: 1;
        transition: opacity 0.4s;
      }

      #searchResults.hidden {
        opacity: 0;
        transition: none;
      }

      paper-icon-item {
        padding: 20px 0;
      }

      iron-image {
        margin-right: 50px;
      }

      paper-icon-button, iron-icon {
        margin-right: 50px;
      }

    </style>

    <firebase-auth id="auth" user="{{user}}"></firebase-auth>

    <firebase-document
        id="fbSpotifyTokenDoc"
        path="/spotify/client_credentials"
        data="{{_spotifyCredentials}}"></firebase-document>

    <iron-ajax
        id="authTokenFunction"
        url="/functions/spotifyauth"
        handle-as="text"
        reject-with-request></iron-ajax>

    <iron-ajax
        id="searchApi"
        url="https://api.spotify.com/v1/search"
        headers$='{"Authorization": "Bearer [[_spotifyToken]]"}'
        params$='{"q":"[[_computeQuery(_searchQuery)]]", "limit":"10", "type":"track", "market":"US"}'
        handle-as="json"
        last-response="{{_response}}"
        reject-with-request
        debounce-duration="300"></iron-ajax>

    <paper-input
        label="Search"
        type="search"
        value="{{_searchQuery}}"
        on-value-changed="_searchChanged"></paper-input>
    
    <div id="searchResults">
      <template is="dom-repeat"
          id="trackRepeat"
          items="[[_response.tracks.items]]"
          as="track"
          on-dom-change="_fadeInOut"
          initial-count="5"
          target-framerate="60">

        <paper-material elevation="1">
          <paper-icon-item>
            <!--<iron-image 
              src="[[track.album.images.0.url]]" 
              style="width:100px; height:100px; background-color: lightgray;"
              sizing="cover"
              preload fade></iron-image>-->
            <paper-item-body two-line>
              <div>[[track.name]]</div>
              <div secondary>[[track.artists.0.name]]</div>
            </paper-item-body>
            <paper-icon-button icon="my-icons:add" on-tap="_addSong" hidden$="[[!user]]"></paper-icon-button>
          </paper-icon-item>
        </paper-material>

      </template>
    </div>

  </template>

  <script>
    class MyView3 extends Polymer.Element {
      static get is() { return 'my-view3'; }

      static get properties() {
        return {
          partyId: String,
          _spotifyCredentials: Object,
          _spotifyToken: String,
          _searchQuery: String,
        }
      }

      static get observers() {
        return [
          '_spotifyCredentialsChanged(_spotifyCredentials.access_token)',
        ];
      }

      _spotifyCredentialsChanged(token) {
        this._spotifyToken = token || '';
      }

      _computeQuery(query) {
        // Check if last 2 characters of query are alphanumueric
        if (query.length > 1 && /^[a-zA-Z0-9]{2}$/.test(query.slice(-2))) {
          return query += '*';
        }
        return query;
      }

      _searchChanged(_, e) {
        if (!e.value.length)
          return;

        this._debouncer = Polymer.Debouncer.debounce(this._debouncer,
                                                     Polymer.Async.timeOut.after(300),
                                                     this._search.bind(this));
      }

      // Expired token BQCWGr8wlGAX_TDAw3u7UxnUovVdN8-s-o24fi3XABfcxWOxbFugv9ZjfmlJYZ8GPfTShMLJ71uMjpVCERaB_w

      _search() {
        if (this.$.authTokenFunction.loading)
          return;

        this._launchSearch(this._searchQuery, this._spotifyToken).catch((err) => {
          if (err.message === 'No token provided' || 
             (err.message === 'The access token expired' && err.status === 401)) {
            return this._getAuthToken().then((response) => {
              this._spotifyToken = response;
              return this._launchSearch(this._searchQuery, this._spotifyToken);
            });
          }
        }).catch((err) => {
          console.log('An error occured while searching', err.message);
        });
      }

      _getAuthToken() {
        return new Promise((resolve, reject) => {
          this.$.authTokenFunction.generateRequest().completes.then((req) => {
            resolve(req.response);
          }).catch((err) => {
            console.log(err.message);
            reject(err.request.response.error);
          });
        });
      }

      _launchSearch(query, token) {
        return new Promise((resolve, reject) => {
          if (!query || !query.length) {
            return reject(new TypeError('No query provided'))
          }
          if (!token || !token.length) {
            return reject(new TypeError('No token provided'));
          }
          this.$.searchApi.generateRequest().completes.then((req) => {
            resolve(req.response);
          }).catch((err) => {
            reject(err.request.response.error);
          });
        });
      }

      _addSong(e) {
        if (!this.user) {
          console.log('Not signed in');
          return;
        }
        const model = this.$.trackRepeat.modelForElement(e.target);
        const ref = firebase.database().ref(`tracks/${this.partyId}`);
        ref.push({
          name: model.track.name,
          artist: model.track.artists[0].name,
          album: model.track.album.name,
          id: model.track.id,
          added_at: firebase.database.ServerValue.TIMESTAMP,
          user_id: this.user.uid,
        }).catch((err) => {
          console.log('Error adding track to queue', err.message);
        })
      }

      _fadeInOut() {
        this.$.searchResults.classList.add('hidden');
        Polymer.Async.timeOut.after(1).run(() => {
          this.$.searchResults.classList.remove('hidden');
        });
      }
    }

    window.customElements.define(MyView3.is, MyView3);
  </script>
</dom-module>
