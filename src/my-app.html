
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">

<!--<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="dblib.html">-->

<link rel="lazy-import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="lazy-import" href="../bower_components/polymerfire/firebase-auth.html">
<link rel="lazy-import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="lazy-import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="lazy-import" href="dblib.html">
<link rel="lazy-import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="lazy-import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="lazy-import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="lazy-import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="dblib.html">

<link rel="lazy-import" href="my-icons.html">

<link rel="import" href="my-view1.html">
<link rel="lazy-import" href="my-queue.html">
<link rel="lazy-import" href="my-view3.html">
<link rel="lazy-import" href="my-404.html">

<dom-module id="my-app">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        padding-top: 64px;
        padding-bottom: 64px;
        min-height: 100vh;

        --primary-color: #1DB954; /* Spotify green */
        --accent-color: #1DB954;
        --app-bar-color: #212121;
        --card-color: #424242;
        --divider-color: rgba(255, 255, 255, 0.12);
        --primary-text-color: #FFFFFF;
        --secondary-text-color: rgba(255, 255, 255, 0.7);
        --icon-color: #FFFFFF;
        --secondary-color: #9E9E9E;
        --primary-background-color: #303030;
        --disabled-text-color: rgba(255, 255, 255, 0.5);
        --disabled-icon-color: rgba(255, 255, 255, 0.5);
        --error-color: #DD2C00;

        color: var(--primary-text-color);
      }

      [hidden] {
        display: none !important;
      }

      #loadingOverlay {
        @apply --layout;
        @apply --layout-center-center;

        position: absolute;
        top: 20px;
        height: 100vh;
        width: 100%;
        z-index: 1;
        background: var(--primary-background-color);
      }

      #loadingOverlay.hidden {
        display: none;
      }

      #header {
        @apply --layout-fixed-top;
        z-index: 2;
        background-color: var(--app-bar-color);
        --app-header-shadow: {
          box-shadow: inset 0px 5px 6px -3px rgba(0, 0, 0, 0.2);
          height: 10px;
          bottom: -10px;
        };
      }

      paper-icon-button {
        color: var(--icon-color);
      }

      #toolbar {
        position: relative;
      }

      #drawer {
        z-index: 3;

        --app-drawer-content-container: {
          background-color: var(--card-color);
        }
      }

      #drawerList {
        margin: 0 20px;
      }

      #drawerList a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--secondary-text-color);
        line-height: 40px;
      }

      #drawerList a.iron-selected {
        color: var(--primary-text-color);
        font-weight: bold;
      }
    
      iron-pages {
        max-width: 1440px;
        margin: 0 auto;
      }

    </style>

    <firebase-app
        api-key="AIzaSyBJxf-hJa7RQVBPYkdjt27yBcDj0b1tG8o"
        auth-domain="spotify-party-da303.firebaseapp.com"
        database-url="https://spotify-party-da303.firebaseio.com/"
        on-firebase-app-initialized="_appInitialized"></firebase-app>

    <firebase-auth
        id="auth"
        provider="google"
        user="{{user}}"
        status-known="{{_authStatusKnown}}"></firebase-auth>

    <firebase-document
        id="fbPartyIdDoc"
        path="/users/[[user.uid]]/party"
        path="[[_computePartyIdDocPath(user.uid)]]"
        data="{{_syncedPartyId}}"></firebase-document>

    <app-location route="{{route}}"></app-location>

    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subRoute}}"></app-route>

    <iron-meta key="phoneMaxWidth" value="[[phoneMaxWidth]]"></iron-meta>
    <iron-meta key="partyCodeFormat" value="[[partyCodeFormat]]"></iron-meta>

    <iron-media-query query="[[phoneMaxWidth]]" query-matches="{{smallScreen}}"></iron-media-query>

    <!-- Loading spinner overlay -->
    <div id="loadingOverlay" class$="[[_computeOverlayClass(loading)]]">
      <paper-spinner-lite id="loadingSpinner" active="[[loading]]"></paper-spinner-lite>
    </div>

    <app-header id="header" role="navigation" condenses reveals effects="waterfall">
      <app-toolbar id="toolbar">
        <paper-icon-button id="hamburgerIcon" icon="my-icons:menu" on-click="_toggleDrawer"></paper-icon-button>
        <div main-title>Spotify Together</div>
        <paper-button raised hidden$="[[!partyId]]" on-tap="_leaveButtonClicked">Leave</paper-button>
        <paper-button raised hidden$="[[_isSignedIn(user)]]" on-tap="_login">Sign-in</paper-button>
        <paper-button raised hidden$="[[!_isSignedIn(user)]]" on-tap="_logout">Logout</paper-button>
      </app-toolbar>
    </app-header>

    <app-drawer id="drawer" opened="{{drawerOpened}}" swipe-open="[[smallScreen]]" transition-duration="400" tabindex="0">
      <app-toolbar>Menu</app-toolbar>
      <iron-selector id="drawerList" selected="[[page]]" attr-for-selected="name" role="navigation">
        <a name="view1" href="view1">View One</a>
        <a name="queue" href="queue">Queue</a>
        <a name="view3" href="view3">View Three</a>
      </iron-selector>
    </app-drawer>

    <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="404" role="main">
      <my-view1 id="view1" name="view1" party-id="[[partyId]]"></my-view1>
      <my-queue name="queue" party-id="[[partyId]]"></my-queue>
      <my-view3 name="view3" party-id="[[partyId]]"></my-view3>
      <my-404 name="404"></my-404>
    </iron-pages>

  </template>

  <script>

    window.performance && performance.mark && performance.mark('app - before register');

    class MyApp extends Polymer.Element {

      static get is() { return 'my-app'; }

      static get properties() {
        return {
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged',
          },

          firebaseLoaded: {
            type: Boolean,
            value: false
          },

          loading: {
            type: Boolean,
            computed: '_computeLoading(_authStatusKnown, redirectHandled)',
          },

          partyId: {
            type: String,
            //observer: '_partyIdChanged'
          },

          appInitialized: {
            type: Function,
            value: () => {
              return Promise.resolve();
            }
          },

          user: Object,

          _syncedPartyId: {
            type: Object,
            observer: '_syncedPartyIdChanged'
          },

         /* _syncedUser: {
            type: Object,
            observer: '_syncedUserChanged'
         },*/

          _authStatusKnown: Boolean,

          subRoute: String,
          routeData: Object,

          // meta
          phoneMaxWidth: {
            type: String,
            value: 'max-width: 640px',
          },

          partyCodeFormat: {
            type: Object,
            value: {
              allowedInput: '^[a-zA-Z]+$',
              exactFormat: new RegExp('^[A-Z]{4}$'),
              length: 4,
            },
          },

        };
      }

      static get observers() {
        return [
          '_authStatus(_authStatusKnown, user)',
          '_lockScroll(loadComplete)',
          //'_routePageChanged(routeData.page)'
        ];
      }

      constructor() {
        super();

        this.redirectHandled = false;
        this.loadComplete = false;

        window.performance && performance.mark && performance.mark('app.created');
      }

      _appInitialized() {
        dblib.init(firebase.database());
        this._handleRedirect().then(() => {
          this.redirectHandled = true;
          console.log('redirect done');
          if (!firebase.auth().currentUser) {
            this.partyId = null;
          }

          this._createPropertyObserver('partyId', '_partyIdChanged', true);
          this._partyIdChanged(this.partyId);
        });
      }

      ready() {
        super.ready();
        // Custom elements polyfill safe way to indicate an element has been upgraded.
        this.removeAttribute('unresolved');
        // listen for custom events
        /*this.addEventListener('add-cart-item', (e) => this._onAddCartItem(e));
        this.addEventListener('set-cart-item', (e) => this._onSetCartItem(e));
        this.addEventListener('clear-cart', (e) => this._onClearCart(e));
        this.addEventListener('change-section', (e) => this._onChangeSection(e));
        this.addEventListener('announce', (e) => this._onAnnounce(e));*/
        this.addEventListener('dom-change', (e) => this._domChange(e));
        this.addEventListener('show-invalid-url-warning', (e) => this._onFallbackSelectionTriggered(e));

        Polymer.RenderStatus.afterNextRender(this, () => {
          console.log('FIRST RENDER');
          this.firstRender = true;
          this._createMethodObserver('_routePageChanged(routeData.page)', true);
          this._routePageChanged(this.routeData.page);
          Polymer.importHref(this.resolveUrl('lazy-firebase-resources.html'), () => {
            console.log('firebase imported');
          }, null, true);


          /*console.log('NEXT RNDER');
          this._attatchObservers();

          Polymer.importHref(this.resolveUrl('lazy-firebase-resources.html'), () => {
            const config = {
              apiKey: "AIzaSyBJxf-hJa7RQVBPYkdjt27yBcDj0b1tG8o",
              authDomain: "spotify-party-da303.firebaseapp.com",
              databaseURL: "https://spotify-party-da303.firebaseio.com/",
            };
            firebase.initializeApp(config);
            dblib.init(firebase);
            this._handleRedirect().then(() => {
              this._createPropertyObserver('partyId', '_partyIdChanged', true);
            });
            Polymer.importHref(this.resolveUrl('lazy.html'), () => {
              console.log('done with firebase elements');
              this.firebaseLoaded = true;
            }, null, true);
          }, null, true);*/

          window.addEventListener('online', (e) => this._notifyNetworkStatus(e));
          window.addEventListener('offline', (e) => this._notifyNetworkStatus(e));
        });
      }

      connectedCallback() {
        super.connectedCallback();
      }

      _routePageChanged(page) {
        //if (this.redirectHandled && this._partyStatusRedirect(this.partyId, page)) {
        //console.log(this.firstRender);
        //if (!this.firstRender || this._partyStatusRedirect(this.partyId, page)) {
        //  return;
       // }

        this.page = page || 'view1';

        this.drawerOpened = false;
      }

      _partyStatusRedirect(partyId, page) {
        if (partyId === undefined) return true;
        if (partyId) {
          if (page === 'view1') {
            this.set('route.path', 'queue');
            return true;
          }
        } else if (page !== 'view1') {
          this.set('route.path', 'view1');
          return true;
        }
        return false;
      }

      _pageChanged(page, oldPage) {
        if (page != null) {
          // home route is eagerly loaded
          if (page == 'view1') {
            this._pageLoaded(Boolean(oldPage));
          // other routes are lazy loaded
          } else {
            // When a load failed, it triggered a 404 which means we need to
            // eagerly load the 404 page definition
            let cb = this._pageLoaded.bind(this, Boolean(oldPage));
            Polymer.importHref(
                this.resolveUrl(`my-${page}.html`),
                cb, cb, true);
          }
        }
      }

      _pageLoaded(shouldResetLayout) {
        console.log('page loaded', this.page);
        this._ensureLazyLoaded();
        if (shouldResetLayout) {
          // The size of the header depends on the page (e.g. on some pages the tabs
          // do not appear), so reset the header's layout only when switching pages.
          Polymer.Async.timeOut.run(() => {
            this.$.header.resetLayout();
          }, 1);
        }
      }
      
      _ensureLazyLoaded() {
        // load lazy resources after render and set `loadComplete` when done.
        if (!this.loadComplete) {
          //Polymer.RenderStatus.afterNextRender(this, () => {
          //Polymer.importHref(this.resolveUrl('lazy-resources.html'), () => {
          //  console.log('lazies');
          //}, null, true);
            Polymer.importHref(this.resolveUrl('lazy-resources.html'), () => {
              // Register service worker if supported.
              if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js', {scope: '/'});
              }
              this._notifyNetworkStatus();
              this.loadComplete = true;
              console.log('lazy loaded');
            }, null, true);
          //});
        }
      }

      _notifyNetworkStatus() {
        let oldOffline = this.offline;
        this.offline = !navigator.onLine;
        // Show the snackbar if the user is offline when starting a new session
        // or if the network status changed.
        /*if (this.offline || (!this.offline && oldOffline === true)) {
          if (!this._networkSnackbar) {
            this._networkSnackbar = document.createElement('shop-snackbar');
            this.root.appendChild(this._networkSnackbar);
          }
          this._networkSnackbar.innerHTML = this.offline ?
              'You are offline' : 'You are online';
          this._networkSnackbar.open();
        }*/
      }

      _toggleDrawer() {
        this.drawerOpened = !this.drawerOpened;
      }

      _login() {
        if (this.user && this.user.isAnonymous) {
          const provider = new firebase.auth.GoogleAuthProvider();
          firebase.auth().currentUser.linkWithRedirect(provider);
        } else {
          this.$.auth.signInWithRedirect();
        }
      }

      _logout() {
        // should use button's on transition end
        this.$.auth.signOut();
      }

      _leaveButtonClicked(e) {
        dblib.leaveParty(this.partyId, this.user.uid);
      }

      _attatchObservers() {
        this._createMethodObserver('_routePageChanged(routeData.page)', true);
        this._routePageChanged(this.routeData.page);
      }

      _handleRedirect() {
        return firebase.auth().getRedirectResult().then((result) => {
          const user = result.user;
          if (!user) return;

          dblib.getUser(user.uid).then((result) => {
            if (!result) return dblib.addUser(user);
          }).catch((err) => {
            console.log('Error adding user', err.message);
          });
          return;
        }).catch((err) => {
          console.log(err.message);

          const prevUser = firebase.auth().currentUser;
          if (!prevUser) return resolve(null);
          const credential = err.credential;
          let prevParty = null;

          return dblib.getUserParty(prevUser.uid).then((partyId) => {
            prevParty = partyId;
            dblib.deleteUser(prevUser, prevParty).catch((err) => {
              console.log('Error deleting user', err.message);
            });
            return firebase.auth().signInWithCredential(credential);
          }).then((user) => {
            return dblib.getUserParty((user.uid)).then((currParty) => {
              if (prevParty && prevParty !== currParty) {
                return dblib.switchToParty(user.uid, prevParty, currParty);
              }
            });
          }).catch((err) => {
            console.log('Error switching parties', err.message);
          });
        });
      }

      _domChange(e) {
        if (window.performance && performance.mark && !this.__loggedDomChange) {
          let target = e.composedPath()[0];
          let host = target.getRootNode().host;
          if (host && host.localName.match(this.page)) {
            this.__loggedDomChange = true;
            performance.mark(host.localName + '.domChange');
          }
        }
      }

      _onFallbackSelectionTriggered() {
        this.page = '404';
      }

      _lockScroll(loadComplete) {
        //document.body.style.overflow = loadComplete ? 'visible' : 'hidden';
        //document.body.style.overflow = 'hidden';
      }

      _isSignedIn(user) {
        return user && !user.isAnonymous;
      }

      _computePartyIdDocPath(uid) {
        return dblib.userPartyPath(uid);
      }

      _partyIdChanged(partyId) {
        //if (!this.redirectHandled) return;
        this._partyStatusRedirect(partyId, this.page);
      }

      _syncedPartyIdChanged(syncedId) {
        const syncedIdEmpty = this.isEmptyObject(syncedId);
        if (!this.partyIdInitialized && syncedIdEmpty) {
          this.partyIdInitialized = true;
          return;
        }
        this.partyId = syncedIdEmpty ? null : syncedId;
      }

      //_syncedUserChanged(syncedUser) {
        //if (!this.userInitialized && !syncedUser) {
        //  this.userInitialized = true;
        //}
       // this.user = syncedUser;
      //}

      _computeOverlayClass(loading) {
        return loading ? '' : 'hidden';
        //return 'hidden';
      }

      _computeLoading(...args) {
        // Returns true if at least one argument is false
        return args.some((el) => !el);
      }

      _authStatus(_authStatusKnown, user) {
        // nothing here
      }

      isEmptyObject(obj) {
        return Object.keys(obj).length === 0 && obj.constructor === Object;
      }

    }

    window.customElements.define(MyApp.is, MyApp);
  </script>
</dom-module>
